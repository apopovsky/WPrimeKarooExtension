# Auto-install W Prime Extension when Karoo is authorized
$adbPath = "$env:LOCALAPPDATA\Android\Sdk\platform-tools\adb.exe"
$apkPath = "app\build\outputs\apk\debug\WPrimeKarooExtension-v1.0.1-debug.apk"

Write-Host "üîÑ Esperando autorizaci√≥n del Karoo..." -ForegroundColor Yellow
Write-Host "üì± Acepta el di√°logo de USB debugging en tu Karoo" -ForegroundColor Cyan
Write-Host ""

# Monitor for device authorization
$maxAttempts = 30
$attempt = 0

while ($attempt -lt $maxAttempts) {
    $devices = & $adbPath devices 2>&1
    $authorizedDevice = $devices | Where-Object { $_ -match "device$" }

    if ($authorizedDevice) {
        Write-Host "‚úÖ Karoo autorizado!" -ForegroundColor Green
        Write-Host "üì¶ Instalando W Prime Extension..." -ForegroundColor Cyan

        # Install the APK
        $installResult = & $adbPath install -r $apkPath 2>&1

        if ($LASTEXITCODE -eq 0) {
            Write-Host ""
            Write-Host "üéâ ¬°W Prime Extension instalada correctamente!" -ForegroundColor Green
            Write-Host ""
            Write-Host "üì± Para usar la extensi√≥n:" -ForegroundColor Cyan
            Write-Host "1. Abre la app Karoo en tu dispositivo" -ForegroundColor White
            Write-Host "2. Ve a Settings > Extensions" -ForegroundColor White
            Write-Host "3. Habilita 'W Prime Monitor'" -ForegroundColor White
            Write-Host "4. Configura los campos en una pantalla de entrenamiento" -ForegroundColor White
            Write-Host ""
            Write-Host "üéØ Campos disponibles:" -ForegroundColor Yellow
            Write-Host "   ‚Ä¢ W Prime Balance - Energ√≠a anaer√≥bica restante" -ForegroundColor Gray
            Write-Host "   ‚Ä¢ W Prime Used - Energ√≠a anaer√≥bica utilizada" -ForegroundColor Gray
            Write-Host "   ‚Ä¢ W Prime Percentage - Porcentaje de energ√≠a restante" -ForegroundColor Gray
        } else {
            Write-Host "‚ùå Error instalando APK:" -ForegroundColor Red
            Write-Host $installResult -ForegroundColor Red
        }
        break
    }

    $attempt++
    Write-Host "‚è≥ Intento $attempt/$maxAttempts - Esperando autorizaci√≥n..." -ForegroundColor Yellow
    Start-Sleep -Seconds 2
}

if ($attempt -ge $maxAttempts) {
    Write-Host "‚è∞ Tiempo agotado esperando autorizaci√≥n" -ForegroundColor Red
    Write-Host "üí° Intenta desconectar y reconectar el Karoo" -ForegroundColor Yellow
}
